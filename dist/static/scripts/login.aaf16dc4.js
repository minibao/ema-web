var wait=60,app=new Vue({el:"#app",data:{uid:0,server:0,loginStyle:!0,role:{},roleid:0,devicetype:"",channelTag:"",openId:"",accessToken:"",wecode:"",appId:20015,tips:"",loginFlag:!0,captchaInfo:"获取验证码","goto":""},methods:{login:function(){var e;if($("#loadingToast").show(),app.loginStyle){if(app.loginFlag)e=/^\d+$/g.test(app.account)?{mobile:app.account,password:app.password,type:"PT",accountType:1,channelTag:app.channelTag,allianceId:app.devicetype}:{email:app.account,password:app.password,type:"PT",accountType:2,channelTag:app.channelTag,allianceId:app.devicetype};else{if(!/^1\d{10}$/.test(app.mobile))return $("#loadingToast").hide(),layer.msg("请输入正确的手机号码或邮箱"),!1;e={mobile:app.mobile,captcha:app.captcha,type:"PT",accountType:1,channelTag:app.channelTag,allianceId:app.devicetype}}$.ajax({type:"POST",url:"/api/getLogin",data:e,success:function(e){$("#loadingToast").hide(),200==e.resultCode?(app.uid=e.data.uid,0!=app.uid&&app.uid&&(console.log(e),"sever"==goto?$(".selectsever").show():"fuli"==goto?"active1"==app["goto"]?location.href="/active/active":location.href="/topic/active2":"active1"==app["goto"]?location.href="/active/active":location.href="/topic/active2",util.setCookie("accout",app.account),util.setCookie("squid",app.uid),util.setCookie("suid",app.uid),util.setCookie("token",e.data.token),util.setCookie("sQtoken",e.data.SQ_token),app.getServer())):alert(e.resultMsg)}})}else e={type:"QD",server:app.server,nickName:app.nickName,appId:app.appId},$.ajax({type:"POST",url:"/api/getLogin",data:e,success:function(e){return $("#loadingToast").hide(),300==e.resultCode?(layer.msg(e.resultMsg),!1):void(e.data?$("#msgCode").show():app.tips="请确认角色名是否正确（数据存在一定延迟）")},error:function(e){$("#loadingToast").hide(),alert(e)}})},QQClick:function(){QC.Login({btnId:"qqLoginBtn",scope:"all",size:"A_XL"}),setTimeout(function(){$("#qqLoginBtn a").html(""),$("#qqLoginBtn a").html('<i class="icon sprite-icon_qq_login"></i>')},10);var e={};QC.api("get_user_info",e).success(function(e){console.log(e)}).error(function(e){alert("获取用户信息失败！")}).complete(function(e){QC.Login.check()&&QC.Login.getMe(function(e,a){app.openId=e,app.accessToken=a,app.QQlogin()})})},QQlogin:function(){var e;$("#loadingToast").show(),e={qqAppId:"101399880",openId:app.openId,type:"QQ",accessToken:app.accessToken,channelTag:app.channelTag,allianceId:app.devicetype},$.ajax({type:"POST",url:"/api/getLogin",data:e,success:function(e){console.log(e),alert(JSON.stringify(e)),e=e.data,$("#loadingToast").hide();try{"0"==e.status,app.uid=e.data.uid}catch(a){return alert("数据异常，稍后重试！"),!1}"0"==e.status&&0!=app.uid&&app.uid&&(app.uid=e.data.uid,$(".selectsever").show(),util.setCookie("squid",app.uid))}})},wechatClick:function(){$("#wechatLoginBtn").click(function(){window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx90ea8be0c05b9630&redirect_uri=https%3A%2F%2Fsocial.lemonade-game.com/users&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect"})},weChatLogin:function(){var e;$("#loadingToast").show(),e={weixinCode:app.wecode,type:"WX",channelTag:app.channelTag,allianceId:app.devicetype},$.ajax({type:"POST",url:"/api/getLogin",data:e,success:function(e){$("#loadingToast").hide();try{if("1"==e.data.tokens.status)return!1;e=e.data.tokens.data;for(var a=new Array,t=new Array,o=0;o<e.length;o++)for(var i=0;i<e[o].loginAppIds.length;i++)20019!=e[o].loginAppIds[i]&&(a.push(e[o].loginAppIds[i]),t.push(e[o].token));for(var o=0;o<a.length;o++)for(var p=o+1;p<a.length;p++)a[o]===a[p]&&(a.splice(o,1),t.splice(o,1),o--);console.log(a),console.log(t),$("#sendlottery").show().removeClass("bounceInUp").addClass("bounceInUp"),$("#select-server-role").html("");for(var n='<option value="-1">请选择游戏</option>',o=0;o<a.length;o++){switch(a[o]=""+a[o],a[o]){case"20012":t[o].game="英灵召唤师";break;case"20015":t[o].game="次元大作战"}n=n+"<option tk="+t[o].token+" uid="+t[o].uid+" appid="+t[o].appId+" value="+a[o]+">"+t[o].game+"</option>"}$("#select-server-role").html(n)}catch(c){return alert("请确认是否通过微信登录过该游戏！"),!1}}})},relogin:function(){$(".selectsever").fadeOut(500,function(){app.loginStyle=!0,util.delCookie("squid"),util.delCookie("token"),util.delCookie("accountId_shequ"),$("#select-server").val("-1"),$("#select-role").val("0"),app.role=""})},getServer:function(){$.ajax({type:"POST",url:"/api/getServer",success:function(e){$("#select-server").html("");try{for(var a=e.serverList,t='<option value="-1">请选择大区</option>',o=0;o<a.length;o++){switch(a[o].serverName){case"天使之门":a[o].serverKey="23000";break;case"天空之城":a[o].serverKey="23002";break;case"绯红暴君":a[o].serverKey="23003"}t=t+"<option value="+a[o].serverKey+">"+a[o].serverName+"</option>"}$("#select-server").html(t)}catch(i){}}})},getRole:function(){return app.uid&&$.ajax({type:"POST",url:"/api/getRole",async:!1,data:{uid:app.uid,server:app.server},success:function(e){app.role=e.data}}),app.role},transfer:function(){if(app.server=$("#select-server").val(),app.loginStyle)app.roleid=$("#select-role").val(),0!=app.roleid&&app.server>0&&0!=app.uid?(util.setCookie("suid",app.uid),util.setCookie("squid",app.uid),util.setCookie("sserver",app.server),util.setCookie("ssource",app.roleid),"sever"==goto?location.href="/users/info?uid="+app.uid+"&server="+app.server+"&source="+app.roleid:"active1"==app["goto"]?location.href="/active/active":location.href="/topic/active2"):alert("请正确的选择信息！");else{if(app.server<0)return alert("请选择区服！"),0;if(!app.nickName||""==app.nickName.trim())return alert("请输入名字！"),0;app.login()}},sendCaptcha:function(){app.msgCode&&($("#loadingToast").show(),postData={type:"QD",server:app.server,nickName:app.nickName,appId:app.appId,msgCode:app.msgCode},$.ajax({type:"POST",url:"/api/checkLoginMsgCode",data:postData,success:function(e){$("#loadingToast").hide();var a=e.data;200==e.resultCode?(util.setCookie("squid",a.uid),util.setCookie("token",a.token.token),util.setCookie("suid",a.uid),util.setCookie("sserver",app.server),util.setCookie("ssource",a.source),a.email||a.mobile?layer.msg("登录成功",{time:3e3},function(){"sever"==goto?location.href="/users/info?uid="+app.uid+"&server="+app.server+"&source="+app.roleid:"active1"==app["goto"]?location.href="/active/active":location.href="/topic/active2"}):layer.msg("登录成功，请绑定账号！",{time:3e3},function(){"sever"==goto?location.href="/users/info?uid="+app.uid+"&server="+app.server+"&source="+app.roleid:"active1"==app["goto"]?location.href="/active/active":location.href="/topic/active2"})):alert("验证码错误！")},error:function(e){$("#loadingToast").hide(),console.log(e),alert(e)}}))},changeServer:function(){$("#select-server").change(function(){if(app.server=$("#select-server").val(),"-1"!=app.server){var e=app.getRole();console.log(e);try{if(!e.length)return!1}catch(a){return!1}setTimeout(function(){e.length>0&&($("#select-role option:eq(1)").prop("selected",!0),app.roleid=$("#select-role").val())},200)}else $("#iosDialog2").show(),$(".weui-mask").fadeIn(200),$("#select-role").val("1")})},changeRole:function(){$("#select-role").change(function(){app.roleid=$("#select-role").val()})},hideDialog:function(){$(".weui-dialog__ft").on("click",function(){$("#iosDialog2").hide(),$(".weui-mask").fadeOut(200)})},getCaptcha:function(){var e=/^1\d{10}$/;if(e.test(app.mobile)){if($("#captchaBtn").addClass("ban"),app.captchaInfo=wait+"S",60==wait){var a=setInterval(function(){wait--,app.captchaInfo=wait+"S",0==wait&&(clearInterval(a),app.captchaInfo="获取验证码",$("#captchaBtn").removeClass("ban"),wait=60)},1e3);app.mobile&&$.ajax({type:"GET",url:"/api/getCaptcha",data:{mobile:app.mobile},success:function(e){200==e.resultCode?layer.msg("验证码发送成功"):layer.msg("验证码发送失败")}})}}else layer.msg("请输入正确的手机号")},getDevice:function(){var e=navigator.userAgent,a=e.indexOf("Android")>-1||e.indexOf("Adr")>-1,t=!!e.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);return a?(app.channelTag=1001,"26"):t?(app.channelTag=0,"70"):(app.channelTag=1001,"26")},changeLoginStyle:function(){app.loginStyle=!1,$(".selectsever").show()},changeCaptchaLogin:function(){app.loginFlag=!app.loginFlag},getUrlParams:function(e){var a=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),t=decodeURI(window.location.search).substr(1).match(a);return null!=t?unescape(t[2]):null},iosold:function(){var e=app.getUrlParams("device");"ios"==e&&($(".re-login").hide(),$(".page__bd").css("background","#02022a"),$(".logopage").hide(),app.uid=util.getCookie("suid"),$(".selectsever").show())},keepselect:function(){var e=util.getCookie("select_server"),a=util.getCookie.getItem("select_role");$("#select-role").append(a),$("#select-server option[value="+e+" ]").prop("selected",!0),$("#select-role option:last").prop("selected",!0)},boxCancel:function(){$("#msgCode").hide()}}});$(document).ready(function(){$(".weui-cell").click(function(){$(this).find(".weui-input").focus()});new Swiper(".swiper-container",{pagination:".swiper-pagination",paginationClickable:!0,autoplay:3e3,autoplayDisableOnInteraction:!1,loop:!0});$("#sendlottery .gbtn").click(function(){var e=$("#select-server-role").val();if(e==-1)layer.msg("请选择已通过微信绑定的游戏！");else{var a=$("#select-server-role").find("option:selected").attr("uid"),t=$("#select-server-role").find("option:selected").attr("tk");util.setCookie("squid",a),util.setCookie("suid",a),util.setCookie("token",t),"active1"==app["goto"]?location.href="/active/active":location.href="/topic/active2"}}),$("#sendlottery .gbtn1").click(function(){$("#sendlottery").hide()})});var goto=app.getUrlParams("goto");app["goto"]=app.getUrlParams("goto"),"active1"==app["goto"]&&util.setCookie("goto","active1");var accout=util.getCookie("accout"),uid=util.getCookie("squid");app.iosold(),null!=uid&&("sever"==goto?$(".selectsever").show():"active1"==app["goto"]?location.href="/active/active":location.href="/topic/active2",$("#select-server").val("-1"),$("#select-role").val("0"),app.uid=uid),app.devicetype=app.getDevice(),app.getServer(),app.changeServer(),app.hideDialog(),app.changeRole();var code=app.getUrlParams("code");app.wecode=code,""!=app.wecode&&null!=app.wecode&&(util.setCookie("wxcode",app.wecode),app.weChatLogin()),app.wechatClick();